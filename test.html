<!DOCTYPE html>
<html>

<head>
  <title>Lightspeed K-Series Web Extension Demo</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
    integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
  <script src="jquery-1.12.4.js"></script>
  <script
    src="https://code.jquery.com/jquery-1.12.4.js"
    integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU="
    crossorigin="anonymous"></script>

  <style>
    @media(min-width: 768px) {
      .flex {
        display: flex;
        align-items: center;
      }

      body {
        font-family: 'Source Sans Pro', sans-serif;
      }
    }

    .btn-outline-primary {
      background-color: #2E61DE !important;
      color: #FFFFFF !important;
      border: none;
    }

    .btn-outline-secondary {
      background-color: #FFFFFF !important;
      color: #FFFFFF !important;
      border: none;
    }

    pre {
      font-size:small;
      overflow: auto;
    }

    .tab-pane {
      margin-bottom: 20px;
    }

    .navbar-nav {
        float:none;
        margin:0 auto;
        display: block;
        text-align: center;
    }

    .navbar-nav > li {
        display: inline-block;
        float:none;
    }

    h3 {
      padding-top: 10px;
    }

    footer {
      padding-top: 30px;
    }

    video {
      background-color: black;
      margin-bottom: 1rem;
    }
          
    #error {
      color: red;
      padding: 0.6rem;
      background-color: rgb(236 157 157);
      margin-bottom: 0.6rem;
      display: none;
    }
  </style
</head>

<body onload="">
  <!--TOP NAV-->
  <nav class="navbar navbar-dark bg-dark mx-auto text-white">
    <ul class="navbar-nav mx-auto">
      <li>
        <a class="navbar-brand" href="#">
          <img
            src="https://www.eposni.com/wp-content/uploads/2021/07/ls-logo-RedBlack.png"
            class="me-2"
            height="30"
            alt="Lightspeed"
            loading="lazy"
          />
        </a>
      </li>
      <li>
        <h6>K-Series Web Extensions Demo</h6>
      </li>
    </ul>
  </nav>
  <!--MAIN CONTAINER-->
  <div class="container-fluid">
    <div class="row">
      <!--SIDEBAR NAV-->
      <div class="col-4 bg-white">
          <div class="list-group" id="list-tab" role="tablist">
            <h3>POS DATA</h3>
            <a class="list-group-item list-group-item-action list-group-item-dark" id="list-context-list" fId="printContext()" data-toggle="list" href="#list-context" role="tab" aria-controls="context">Show POS Context</a>
            <a class="list-group-item list-group-item-action list-group-item-dark" id="list-version-list" fId="printVersion()" data-toggle="list" href="#list-version" role="tab" aria-controls="version">Show App Version</a>
            <h3>ACCOUNT</h3>
            <a class="list-group-item list-group-item-action list-group-item-dark" id="list-account-list" fId="getCurrentAccount()" data-toggle="list" href="#list-account" role="tab" aria-controls="account">Show Current Account</a>
      </div>
      </div>
      </div>
      <!--TAB CONTENTs-->
      <div class="col-8 bg-white">
          <div class="tab-content" id="nav-tabContent">
            <!-- ERROR MESSAGE ALERT-->
            <div class="alert alert-danger alert-dismissible fade hide" role="alert" id="errorAlert">
            </div>
            <!--POS DATA-->
            <!--Show POS Context-->
            <div class="tab-pane fade show" role="tabpanel" aria-labelledby="list-context-list" id="list-context">
              <div class="card text-white bg-dark mb-3">
                <div class="card-header">POS Context</div>
                <div class="card-body">
                  <div id="list-context-content"></div>
                </div>
              </div>
              <div class="card bg-dark">
                <div class="card-header text-white">Code Example</div>
                <div class="card-body">
                  <p class="card-text">
                    <pre class="fs-6 pretty-printed">
                      <code class="language-javascript text-white">
                      posContext.businessId
                      posContext.businessName
                      posContext.locationId
                      posContext.deviceName
                      posContext.deviceId
                      posContext.userName
                      posContext.userId
                      </code>
                </pre>
                  </p>
                </div>
              </div>
            </div>
            <!--Show POS App Version-->
            <div class="tab-pane fade" role="tabpanel" aria-labelledby="list-version-list" id="list-version">
              <div class="card text-white bg-dark mb-3">
                <div class="card-header">POS App Version</div>
                <div class="card-body">
                  <div id="list-version-content"></div>
                </div>
              </div>
              <div class="card bg-dark mb-3">
                <div class="card-header text-white">Code Example</div>
                <div class="card-body">
                  <p class="card-text">
                    <pre class="fs-6 pretty-printed">
                      <code class="language-javascript text-white">
                        function pos_getVersion(callback) {
                          const callbackId = pos_generateCallbackId()
                          callbacks[callbackId] = callback
                      
                          const data = {
                              name : 'getVersion',
                              args : { callbackId }
                          }
                      
                          pos_postMessage(data)
                      }
                      Fetches the POS app's version number.
                      
                      @param {posCallback} callback
                      The callback that will be invoked when the native function is done executing.
                      </code>
                    </pre>
                  </p>
                </div>
              </div>
            </div>

            <!--ACCOUNT-->
            <!--Get Current Account-->
            <div class="tab-pane fade" role="tabpanel" aria-labelledby="list-account-list" id="list-account">
              <div class="card text-white bg-dark mb-3">
                <div class="card-header">Current Account Details</div>
                <div class="card-body">
                  <div id="list-account-content"></div>
                </div>
              </div>
              <div class="card bg-dark mb-3">
                <div class="card-header text-white">Code Example</div>
                <div class="card-body">
                  <p class="card-text">
                    <pre class="fs-6">
                      <code class="language-javascript text-white">
                        function pos_getCurrentAccount(callback) {
                          const callbackId = pos_generateCallbackId()
                          callbacks[callbackId] = callback
                      
                          const data = {
                              name : 'getCurrentAccount',
                              args : { callbackId }
                          }
                      
                          pos_postMessage(data)
                      }
                      Fetches the current account.
                      
                      @param {posCallback} callback
                      The callback that will be invoked when the native function is done executing.
                      </code>
                    </pre>
                  </p>
                </div>
              </div>
            </div>
  <script>
      function syntaxHighlight(json) {
        if (typeof json != 'string') {
          json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'key';
            } else {
              cls = 'string';
            }
          } else if (/true|false/.test(match)) {
            cls = 'boolean';
          } else if (/null/.test(match)) {
            cls = 'null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        });
      }

      //POS NATIVE FUNCTIONS
      //PRINT POS CONTEXT
      function printContext() {
        document.getElementById("list-context-content").innerHTML = "<pre class='text-white'>"+JSON.stringify(posContext, undefined, 2)+"</pre>"
      }

      //GET POS APP VERSION
      function printVersion() {
        console.log("Show App Version")
        const printResult = function (response) {
          document.getElementById("list-version-content").innerHTML = "App Version: " + response.data
        };
        pos_getVersion(printResult)
      }

      //GET CURRENT ACCOUNT DETAILS
      function getCurrentAccount() {
        const printResult = function (response) {
          document.getElementById("list-account-content").innerHTML = "<pre class='text-white'>"+JSON.stringify(response.data, undefined, 2)+"</pre>"
        };
        pos_getCurrentAccount(printResult)
      }

      //LOAD ACCOUNT BY NUMBER
      function loadAccountForNumber(accountNumber) {
        console.log(accountNumber)
        try { pos_loadAccountForNumber(accountNumber) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      //LOAD ACCOUNT BY NAME
      function loadAccountForName(accountName) {
        console.log(accountName)
        try { pos_loadAccountForName(accountName) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      /*
      Adds the specified item to the current account.
      pos_addItemToCurrentAccount(itemId)
      */
      function addItemToCurrentAccount(itemID) {
        console.log(itemID)
        try { pos_addItemToCurrentAccount(itemID) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      /*
      Adds the specified special item to the current account.
      pos_addSpecialItemToCurrentAccount(itemId, priceCents, name)
      */
      function addSpecialItemToCurrentAccount(specialItemID,specialItemPrice,specialItemName) {
        console.log(specialItemID+"-"+specialItemPrice+"-"+specialItemName)
        try { pos_addSpecialItemToCurrentAccount(specialItemID,specialItemPrice*100,specialItemName) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }
      
      /*
      Set Consumer to current account
      pos_setConsumer(consumer)
      */
      function setConsumer(identifier, firstName, lastName, emailAddress) {
        try { pos_setConsumer({ "identifier": identifier, "firstName": firstName, "lastName": lastName, "email": emailAddress }) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      /*
      Set Account Covers
      pos_setCurrentAccountCovers(covers)
      */
      function setCurrentAccountCovers(accountCovers) {
        try { pos_setCurrentAccountCovers(accountCovers) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      //CHANGE ACCOUNT Profile
      function changeAccountProfile(accountProfileCode) {
        console.log(accountProfileCode)
        try { pos_changeAccountProfile(accountProfileCode) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      //Get Available Discounts
      function getAvailableDiscounts() {
        const printResult = function (response) {
          document.getElementById("list-discounts-content").innerHTML = "<pre class='text-white'>"+JSON.stringify(response.data, undefined, 2)+"</pre>"
        };
        pos_getAvailableDiscounts(printResult)
      }

      //Apply a discount code to a line item of the account. Use "identifier" of the line item in the transactionLines and Account specific discount Code. 
      function toggleDiscount(itemDiscountCode, lineId, callback) {
        const toggleDiscountCallback = function(response) {
          pos_close()
        }
        try { 
          pos_toggleDiscount(itemDiscountCode, lineId, toggleDiscountCallback) 
        }
        catch (error) { 
          window.prompt(error) 
        }
      }

      //Apply a discount code tothe account. i.e. to the whole receipt. Use transaction+account specific discount Code. 
      function toggleGlobalDiscount(discountCode, callback) {
        const toggleGlobalDiscountCallback = function(response) {
          pos_close()
        }
        try { pos_toggleGlobalDiscount(discountCode, toggleGlobalDiscountCallback) }
        catch (error) { window.prompt(error) }
      }

      /*
      Adds a payment to the current account.
      pos_addPayment(amountCents, paymentMethodCode, callback)
      */
      function addPayment(paymentAmount,paymentMethodCode) {
        const callback = function (response) {
          document.getElementById("errorAlert").innerHTML = response; $('.alert').alert()
          pos_close()
        }
        pos_addPayment(paymentAmount *100, paymentMethodCode, callback)
      }

      /*
      Pays for the current account.
      pos_payAccount(paymentMethodCode, callback) 
      THIS WILL MAKE FULL PAYMENT AMOUNT
      */
      function payAccount(paymentMethodCode) {
        const callback = function (response) {
          document.getElementById("errorAlert").innerHTML = response; $('.alert').alert();
          pos_close()
        }
        pos_payAccount(paymentMethodCode, callback)
      }
      
       /*
      PRINT TEXT MESSAGE TO PRINTER
      pos_printText(text)
      */
      function printMessage(message) {
        console.log(message)
        try {  pos_printText(message) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      /*
      Adds an external reference with the specified prefix.
      pos_addExternalReference(reference, prefix) 
      */
      function addExternalReference(externalReference,prefix) {
        console.log(externalReference+"-"+prefix)
        try { pos_addExternalReference(externalReference, prefix)}
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      /*
      Stores data in the POS app's defaults using the specified key.
      pos_storeData(key, value)
      */
      function saveData(key,value) {
        console.log(key+"-"+value)
        try { pos_storeData(key, value) }
        catch (error) { document.getElementById("errorAlert").innerHTML = error; $('.alert').alert() }
        finally { pos_close() }
      }

      /*
      Loads data from the POS app's defaults using the specified key.
      pos_loadData(key, callback)
      */
      function loadData(key) {
        const callback = function (response) {
          document.getElementById("loadData").placeholder = response.data
          document.getElementById("errorAlert").innerHTML = response.data
          $('.alert').alert()
        };
        pos_loadData(key, callback)
      }

      //HIDE CONTENT
      function hideContent(name) {
        document.getElementById(name).innerHTML = ""
      }

      /*
      Camera Functions
      */
      const videoElem = document.getElementById('video');
      const errorElem = document.getElementById('error');
      let receivedMediaStream = null;
  
      //Declare the MediaStreamConstraints object
      const constraints = {
        audio: true,
        video: {
          facingMode: { exact: "environment" }
        }
      }
  
      function openCamera() {
//Ask the User for the access of the device camera and microphone
            navigator.mediaDevices.getUserMedia(constraints)
                .then(mediaStream => {
                    // The received mediaStream contains both the 
                    // video and audio media data
  
//Add the mediaStream directly to the source of the video element
                    // using the srcObject attribute
                    videoElem.srcObject = mediaStream;
  
                    // make the received mediaStream available globally
                    receivedMediaStream = mediaStream;
  
                }).catch(err => {
                    // handling the error if any
                    errorElem.innerHTML = err;
                    errorElem.style.display = "block";
                });
  
        }
  
      const closeCamera = () => {
            if (!receivedMediaStream) {
                errorElem.innerHTML = "Camera is already closed!";
                errorElem.style.display = "block";
            } else {
/* MediaStream.getTracks() returns an array of all the 
MediaStreamTracks being used in the received mediaStream
we can iterate through all the mediaTracks and 
stop all the mediaTracks by calling its stop() method*/
                receivedMediaStream.getTracks().forEach(mediaTrack => {
                    mediaTrack.stop();
                });
                errorElem.innerHTML = "Camera closed successfully!"
                errorElem.style.display = "block";
            }
        }

      //Control Active Tab Actions.
      //POS CONTEXT
      $('#list-tab #list-context-list').on('click', function (e) {
        e.preventDefault()
        console.log("Print Context")
        printContext()
        $(this).tab('show')
      })

      $('#list-tab #list-version-list').on('click', function (e) {
        e.preventDefault()
        console.log("Show App Version")
        printVersion()
        $(this).tab('show')
      })

       //ACCOUNT
      $('#list-tab #list-account-list').on('click', function (e) {
        e.preventDefault()
        console.log("Show Current Account")
        getCurrentAccount()
        $(this).tab('show')
      })

      //DISCOUNT
      $('#list-tab #list-discounts-list').on('click', function (e) {
        e.preventDefault()
        console.log("Load Available Discounts")
        getAvailableDiscounts()
        $(this).tab('show')
      })

      $('#list-tab #list-applyDiscountItem-list').on('click', function (e) {
        e.preventDefault()
        const printItemDiscountsResult = function (response) {
          var list = document.getElementById("itemDiscountCodeDropdown") 
          list.innerHTML = ""
          $.each(response.data, function(key, entry) {
            var li = document.createElement("li")
            var link = document.createElement("a")           
            var text = document.createTextNode(entry.code)
            link.appendChild(text);
            link.href = "#"
            link.setAttribute('value', entry.code)
            link.classList.add("dropdown-item")
            li.appendChild(link)
            list.appendChild(li)
          })
          $('#itemDiscountCodeDropdown a').on('click', function (e) {
            $('#itemDiscountCode').attr('value', $(this).attr('value'))
            $('#itemDiscountCode').text($(this).text())
          })
        };
        pos_getAvailableDiscounts(printItemDiscountsResult)
        
        const printLineIdResult = function (response) {
          var list = document.getElementById("itemLineIdDropdown") 
          list.innerHTML = ""
          $.each(response.data.transactionLines, function(key, entry) {
            var li = document.createElement("li")
            var link = document.createElement("a")           
            var text = document.createTextNode(entry.text)
            link.appendChild(text);
            link.href = "#"
            link.setAttribute('value', entry.identifier)
            link.classList.add("dropdown-item")
            li.appendChild(link)
            list.appendChild(li)
          })
          $('#itemLineIdDropdown a').on('click', function (e) {
            $('#itemLineId').attr('value', $(this).attr('value'))
            $('#itemLineId').text($(this).text())
          })
        };
        pos_getCurrentAccount(printLineIdResult)
        
      })

      $('#list-tab #list-applyGlobalDiscount-list').on('click', function (e) {
        e.preventDefault()
        const printGlobalDiscountsResult = function (response) {
          var list = document.getElementById("globalDiscountCodeDropdown") 
          list.innerHTML = ""
          $.each(response.data, function(key, entry) {
            var li = document.createElement("li")
            var link = document.createElement("a")           
            var text = document.createTextNode(entry.code)
            link.appendChild(text);
            link.href = "#"
            link.setAttribute('value', entry.code)
            link.classList.add("dropdown-item")
            li.appendChild(link)
            list.appendChild(li)
          })
          $('#globalDiscountCodeDropdown a').on('click', function (e) {
            $('#globalDiscountCode').attr('value', $(this).attr('value'))
            $('#globalDiscountCode').text($(this).text())
          })
        };
        pos_getAvailableDiscounts(printGlobalDiscountsResult)
      })

      //POS ACTIONS
      
      //Open Drawer
      $('#list-tab #list-openDrawer-list').on('click', function (e) {
        e.preventDefault()
        document.getElementById("errorAlert").innerHTML = "Opening Cashdrawer! pos_openDrawer()" 
        pos_openDrawer()
        $('.alert').alert() 
        $(this).tab('show')
      })

      //Close Web Extension
      $('#list-tab #list-closePOS-list').on('click', function (e) {
        e.preventDefault()
        document.getElementById("errorAlert").innerHTML = "Closing Web Extension! pos_close()" 
        pos_close()
        $('.alert').alert() 
        $(this).tab('show')
      })

  </script>
</body>
<footer class="bg-white text-right text-lg-start">
  <!-- FOOTER -->
  <div class="bg-white text-right p-3">
    Version: 1.3.4
  </div>
  <!-- FOOTER -->
</footer>
</html>
